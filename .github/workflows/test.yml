name: Backend Tests

on:
  push:
    branches: [ master, main, develop, ci/cd ]
    paths:
      - 'backend/**'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [ master, main, develop ]
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  test:
    name: Run Backend Tests
    runs-on: self-hosted

    env:
      NODE_ENV: test
      DB_HOST: 127.0.0.1
      DB_PORT: 3307        # Use 3307 to avoid conflict with local dev/prod MySQL (usually 3306)
      TEST_DB_NAME: Lefty_Test
      TEST_DB_USER: lefty_test_user
      TEST_DB_PASSWORD: "123456"

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üê≥ Start Test Database
        run: |
          echo "Starting isolated MySQL container for testing..."
          # Clean up any leftover container from previous aborted runs
          docker rm -f lefty_test_db || true
          
          # Run MySQL on port 3307
          docker run -d \
            --name lefty_test_db \
            -p 3307:3306 \
            -e MYSQL_ROOT_PASSWORD=root_password \
            -e MYSQL_DATABASE=Lefty_Test \
            mysql:8

      - name: üßæ Load ENV_FILE secret and export to environment
        shell: bash
        run: |
          echo "Writing ENV_FILE secret to .env"
          echo "${{ secrets.ENV_FILE }}" > .env

          set -o allexport
          source .env || true
          set +o allexport

          if [[ -n "${UPSTASH_REDIS_REST_URL:-}" ]]; then
            echo "UPSTASH_REDIS_REST_URL=${UPSTASH_REDIS_REST_URL}" >> $GITHUB_ENV
          fi
          if [[ -n "${UPSTASH_REDIS_REST_TOKEN:-}" ]]; then
            echo "UPSTASH_REDIS_REST_TOKEN=${UPSTASH_REDIS_REST_TOKEN}" >> $GITHUB_ENV
          fi

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: üì¶ Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: ‚è≥ Wait for MySQL
        run: |
          echo "Waiting for MySQL to be ready on port 3307..."
          
          # Wait for TCP port 3307
          for i in {1..30}; do
            if nc -z 127.0.0.1 3307; then
              echo "TCP Port 3307 is open!"
              break
            fi
            echo "Waiting for TCP port... ($i/30)"
            sleep 2
          done

          # Wait for MySQL service
          for i in {1..30}; do
            # Note: -P 3307 added
            if mysqladmin ping -h 127.0.0.1 -P 3307 -u root -proot_password --silent; then
              echo "MySQL is ready!"
              break
            fi
            echo "Waiting for MySQL service... ($i/30)"
            sleep 2
          done
          
      - name: üóÑÔ∏è Create test database and initialize schema
        run: |
          echo "Creating database and schema..."
          
          # All mysql commands must use -P 3307
          MYSQL_CMD="mysql -h 127.0.0.1 -P 3307 -u root -proot_password"

          $MYSQL_CMD -e "
            CREATE USER IF NOT EXISTS 'lefty_test_user'@'%' IDENTIFIED BY '123456';
            GRANT ALL PRIVILEGES ON Lefty_Test.* TO 'lefty_test_user'@'%';
            FLUSH PRIVILEGES;
          " || true
          
          $MYSQL_CMD -e "CREATE DATABASE IF NOT EXISTS Lefty_Test;"
          
          $MYSQL_CMD Lefty_Test < mysql-init/schema.sql
          
          echo "‚úÖ Database and schema created successfully"
          
      - name: üîç Verify Database Schema
        run: |
          MYSQL_CMD="mysql -h 127.0.0.1 -P 3307 -u root -proot_password Lefty_Test"
          
          echo "È©óË≠âË≥áÊñôÂ∫´Ë°®Ê†º..."
          $MYSQL_CMD -e "SHOW TABLES;"
          echo ""
          echo "È©óË≠â users Ë°®ÁµêÊßã..."
          $MYSQL_CMD -e "DESCRIBE users;"

      - name: üè™ Setup Test Data (5000 merchants)
        working-directory: ./backend
        run: |
          echo "=================================="
          echo "üìä ÁîüÊàêÊ∏¨Ë©¶Ë≥áÊñô"
          echo "=================================="
          npm run test:setup
        timeout-minutes: 10

      - name: üöÄ Redis Performance Test
        working-directory: ./backend
        run: |
          echo "=================================="
          echo "‚ö° Redis ÊïàËÉΩÊ∏¨Ë©¶"
          echo "=================================="
          npm run test:redis
        timeout-minutes: 5

      - name: üßπ Cleanup Test Data
        if: always()
        run: |
          echo "=================================="
          echo "üóëÔ∏è Ê∏ÖÁêÜÊ∏¨Ë©¶Ë≥áÊñôËàáÂÆπÂô®"
          echo "=================================="
          # Attempt to run the cleanup script (optional, as we destroy the container anyway)
          cd backend && npm run test:cleanup || echo "Cleanup script warning"
          
          # Force remove the test container
          docker rm -f lefty_test_db || true