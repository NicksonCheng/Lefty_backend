name: Backend Tests

on:
  push:
    branches: [ master, main, develop ]
    paths:
      - 'backend/**'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [ master, main, develop ]
    paths:
      - 'backend/**'
  workflow_dispatch: # ÂÖÅË®±ÊâãÂãïËß∏Áôº

jobs:
  test:
    name: Run Backend Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: Lefty_Test
          MYSQL_USER: lefty_test_user
          MYSQL_PASSWORD: "123456"
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        # ÈóúÈçµÔºöË®≠ÂÆö localhost aliasÔºåËÆì service ÂèØÁî®
        networks:
          default: {}

    env:
      NODE_ENV: test
      DB_HOST: localhost  # ÊîπÁÇ∫ localhostÔºàËÄå‰∏çÊòØ mysqlÔºâ
      DB_PORT: 3306
      TEST_DB_NAME: Lefty_Test
      TEST_DB_USER: lefty_test_user
      TEST_DB_PASSWORD: "123456"
      # UPSTASH credentials will be loaded from the ENV_FILE secret at runtime

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üßæ Load ENV_FILE secret and export to environment
        shell: bash
        run: |
          echo "Writing ENV_FILE secret to .env"
          # Write the ENV_FILE secret contents to .env
          echo "${{ secrets.ENV_FILE }}" > .env

          # Load .env into the current shell and export variables to GITHUB_ENV
          set -o allexport
          source .env || true
          set +o allexport

          # Ensure Upstash variables (if present) are available to subsequent steps
          if [[ -n "${UPSTASH_REDIS_REST_URL:-}" ]]; then
            echo "UPSTASH_REDIS_REST_URL=${UPSTASH_REDIS_REST_URL}" >> $GITHUB_ENV
          fi
          if [[ -n "${UPSTASH_REDIS_REST_TOKEN:-}" ]]; then
            echo "UPSTASH_REDIS_REST_TOKEN=${UPSTASH_REDIS_REST_TOKEN}" >> $GITHUB_ENV
          fi

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: üì¶ Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: ‚è≥ Wait for MySQL
        run: |
          echo "Waiting for MySQL to be ready..."
          for i in {1..30}; do
            if mysqladmin ping -h localhost -u root -proot_password --silent; then
              echo "MySQL is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: üóÑÔ∏è Initialize Database Schema
        run: |
          echo "Creating database schema..."
          mysql -h localhost -u root -proot_password Lefty_Test < mysql-init/schema.sql
          echo "‚úÖ Database schema created successfully"

      - name: üè™ Setup Test Data (5000 merchants)
        working-directory: ./backend
        run: |
          echo "=================================="
          echo "üìä ÁîüÊàêÊ∏¨Ë©¶Ë≥áÊñô"
          echo "=================================="
          npm run test:setup
        timeout-minutes: 10

      - name: üöÄ Redis Performance Test
        working-directory: ./backend
        run: |
          echo "=================================="
          echo "‚ö° Redis ÊïàËÉΩÊ∏¨Ë©¶"
          echo "=================================="
          npm run test:redis
        timeout-minutes: 5

      - name: üìä Display Test Summary
        if: success()
        run: |
          echo "=================================="
          echo "‚úÖ Ê∏¨Ë©¶ÂÆåÊàêÊëòË¶Å"
          echo "=================================="
          echo "- ÂïÜÂÆ∂Êï∏Èáè: 5000"
          echo "- È§êÁõíÊï∏Èáè: 25000"
          echo "- Redis Ê∏¨Ë©¶ÁØÑÂúç: 3km, 5km, 10km, 15km, 20km"
          echo "=================================="

      - name: üßπ Cleanup Test Data
        working-directory: ./backend
        if: always() # Âç≥‰ΩøÊ∏¨Ë©¶Â§±Êïó‰πüË¶ÅÊ∏ÖÁêÜ
        run: |
          echo "=================================="
          echo "üóëÔ∏è Ê∏ÖÁêÜÊ∏¨Ë©¶Ë≥áÊñô"
          echo "=================================="
          npm run test:cleanup || echo "Cleanup completed with warnings"

      - name: üìà Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            backend/tests/*.log
          retention-days: 7
          if-no-files-found: ignore
