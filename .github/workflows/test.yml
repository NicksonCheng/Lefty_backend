name: Backend Tests

on:
  push:
    branches: [ master, main, develop ]
    paths:
      - 'backend/**'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [ master, main, develop ]
    paths:
      - 'backend/**'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  test:
    name: Run Backend Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: Lefty_Test
          MYSQL_USER: lefty_test_user
          MYSQL_PASSWORD: "123456"
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        # é—œéµï¼šè¨­å®š localhost aliasï¼Œè®“ service å¯ç”¨
        networks:
          default: {}

    env:
      NODE_ENV: test
      DB_HOST: localhost  # æ”¹ç‚º localhostï¼ˆè€Œä¸æ˜¯ mysqlï¼‰
      DB_PORT: 3306
      TEST_DB_NAME: Lefty_Test
      TEST_DB_USER: lefty_test_user
      TEST_DB_PASSWORD: "123456"
      # UPSTASH credentials will be loaded from the ENV_FILE secret at runtime

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§¾ Load ENV_FILE secret and export to environment
        shell: bash
        run: |
          echo "Writing ENV_FILE secret to .env"
          # Write the ENV_FILE secret contents to .env
          echo "${{ secrets.ENV_FILE }}" > .env

          # Load .env into the current shell and export variables to GITHUB_ENV
          set -o allexport
          source .env || true
          set +o allexport

          # Ensure Upstash variables (if present) are available to subsequent steps
          if [[ -n "${UPSTASH_REDIS_REST_URL:-}" ]]; then
            echo "UPSTASH_REDIS_REST_URL=${UPSTASH_REDIS_REST_URL}" >> $GITHUB_ENV
          fi
          if [[ -n "${UPSTASH_REDIS_REST_TOKEN:-}" ]]; then
            echo "UPSTASH_REDIS_REST_TOKEN=${UPSTASH_REDIS_REST_TOKEN}" >> $GITHUB_ENV
          fi

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: â³ Wait for MySQL
        run: |
          echo "Waiting for MySQL to be ready..."
          for i in {1..30}; do
            if mysqladmin ping -h localhost -u root -proot_password --silent; then
              echo "MySQL is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          
      - name: ğŸ—„ï¸ Create test database and initialize schema
        run: |
          echo "Creating database and schema..."
          
          # 1. å»ºç«‹è³‡æ–™åº«ç”¨æˆ¶ï¼ˆé˜²æ­¢å·²å­˜åœ¨éŒ¯èª¤ï¼‰
          mysql -h localhost -u root -proot_password -e "
            CREATE USER IF NOT EXISTS 'lefty_test_user'@'%' IDENTIFIED BY '123456';
            GRANT ALL PRIVILEGES ON Lefty_Test.* TO 'lefty_test_user'@'%';
            FLUSH PRIVILEGES;
          " || true
          
          # 2. å»ºç«‹è³‡æ–™åº«
          mysql -h localhost -u root -proot_password -e "CREATE DATABASE IF NOT EXISTS Lefty_Test;"
          
          # 3. åŸ·è¡Œ schema.sql å»ºç«‹è¡¨
          mysql -h localhost -u root -proot_password Lefty_Test < mysql-init/schema.sql
          
          echo "âœ… Database and schema created successfully"
          
      - name: ğŸ” Verify Database Schema
        run: |
          echo "é©—è­‰è³‡æ–™åº«è¡¨æ ¼..."
          mysql -h localhost -u root -proot_password Lefty_Test -e "SHOW TABLES;"
          echo ""
          echo "é©—è­‰ users è¡¨çµæ§‹..."
          mysql -h localhost -u root -proot_password Lefty_Test -e "DESCRIBE users;"
          echo ""
          echo "é©—è­‰ merchants è¡¨çµæ§‹..."
          mysql -h localhost -u root -proot_password Lefty_Test -e "DESCRIBE merchants;"
          echo ""
          echo "é©—è­‰ mealboxes è¡¨çµæ§‹..."
          mysql -h localhost -u root -proot_password Lefty_Test -e "DESCRIBE mealboxes;"

      - name: ğŸª Setup Test Data (5000 merchants)
        working-directory: ./backend
        run: |
          echo "=================================="
          echo "ğŸ“Š ç”Ÿæˆæ¸¬è©¦è³‡æ–™"
          echo "=================================="
          npm run test:setup
        timeout-minutes: 10

      - name: ğŸš€ Redis Performance Test
        working-directory: ./backend
        run: |
          echo "=================================="
          echo "âš¡ Redis æ•ˆèƒ½æ¸¬è©¦"
          echo "=================================="
          npm run test:redis
        timeout-minutes: 5

      - name: ğŸ“Š Display Test Summary
        if: success()
        run: |
          echo "=================================="
          echo "âœ… æ¸¬è©¦å®Œæˆæ‘˜è¦"
          echo "=================================="
          echo "- å•†å®¶æ•¸é‡: 5000"
          echo "- é¤ç›’æ•¸é‡: 25000"
          echo "- Redis æ¸¬è©¦ç¯„åœ: 3km, 5km, 10km, 15km, 20km"
          echo "=================================="

      - name: ğŸ§¹ Cleanup Test Data
        working-directory: ./backend
        if: always() # å³ä½¿æ¸¬è©¦å¤±æ•—ä¹Ÿè¦æ¸…ç†
        run: |
          echo "=================================="
          echo "ğŸ—‘ï¸ æ¸…ç†æ¸¬è©¦è³‡æ–™"
          echo "=================================="
          npm run test:cleanup || echo "Cleanup completed with warnings"

      - name: ğŸ“ˆ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            backend/tests/*.log
          retention-days: 7
          if-no-files-found: ignore
