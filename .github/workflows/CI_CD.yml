name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master", "ci/cd" ]
  pull_request:
    branches: [ "main", "master", "ci/cd" ]
  workflow_dispatch:

jobs:
  # CI
  test:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Run Linter
      run: npm run lint

    - name: Run Tests
      # Since jest.config.js matches **/*.test.ts, and only health.test.ts matches, 
      # running 'npm test' is sufficient and safe.
      run: npm test

  # CD
  deploy:
    runs-on: self-hosted
    needs: test
    if: success()
    
    steps:
      - name: éƒ¨ç½²ç‹€æ…‹æª¢æŸ¥
        run: |
          echo "è§¸ç™¼äº‹ä»¶: ${{ github.event_name }}"
          echo "å·¥ä½œæµç¨‹åç¨±: ${{ github.workflow }}"
          echo "å‰ç½® job (test) ç‹€æ…‹: æˆåŠŸ"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env

      - name: Docker Compose é‡å•Ÿ
        run: |
          echo "ğŸš€ é–‹å§‹éƒ¨ç½²..."
          
          # å¼·åˆ¶ç§»é™¤å·²å­˜åœ¨çš„å®¹å™¨ä»¥é¿å…åç¨±è¡çª
          docker rm -f mysql_db backend_app_1 backend_app_2 backend_app_3 nginx_proxy || true
          
          # åœæ­¢ä¸¦ç§»é™¤èˆŠçš„å®¹å™¨ç¶²è·¯
          docker compose down --remove-orphans
          
          # é‡æ–°å»ºç½®ä¸¦å•Ÿå‹•
          docker compose up -d --build
          
          # æ¸…ç†æ‡¸ç©ºçš„ Docker æ˜ åƒæª”
          docker image prune -f
          
          echo "âœ¨ éƒ¨ç½²å®Œæˆ $(date)"
