name: Deploy

on:
  workflow_run:
    workflows: ["Backend_Tests"]
    types: [completed]
    branches: [ "main", "master", "ci/cd" ]  # æ˜ç¢ºæŒ‡å®šåˆ†æ”¯
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    # ä¿®æ”¹æ¢ä»¶ï¼šå…è¨± workflow_runï¼Œä½†è¦æ±‚å®ƒæˆåŠŸ
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    
    steps:
      - name: éƒ¨ç½²ç‹€æ…‹æª¢æŸ¥
        run: |
          echo "è§¸ç™¼äº‹ä»¶: ${{ github.event_name }}"
          echo "å·¥ä½œæµç¨‹åç¨±: ${{ github.workflow }}"
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "å‰ç½®å·¥ä½œæµç¨‹çµè«–: ${{ github.event.workflow_run.conclusion }}"
            echo "å‰ç½®å·¥ä½œæµç¨‹åˆ†æ”¯: ${{ github.event.workflow_run.head_branch }}"
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env

      - name: Docker Compose é‡å•Ÿ
        run: |
          echo "ğŸš€ é–‹å§‹éƒ¨ç½²..."
          
          docker rm -f mysql_db backend_app_1 backend_app_2 backend_app_3 nginx_proxy || true
          docker compose down --remove-orphans
          docker compose up -d --build
          docker image prune -f
          
          echo "âœ¨ éƒ¨ç½²å®Œæˆ $(date)"