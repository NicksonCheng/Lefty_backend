name: Deploy

on:
  workflow_run:
    workflows: ["Backend Tests"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: éƒ¨ç½²ç‹€æ…‹æª¢æŸ¥
        run: |
          echo "è§¸ç™¼äº‹ä»¶: ${{ github.event_name }}"
          echo "å·¥ä½œæµç¨‹åç¨±: ${{ github.workflow }}"
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "å‰ç½®å·¥ä½œæµç¨‹çµè«–: ${{ github.event.workflow_run.conclusion }}"
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env

      - name: Docker Compose é‡å•Ÿ
        run: |
          echo "ğŸš€ é–‹å§‹éƒ¨ç½²..."
          
          # å¼·åˆ¶ç§»é™¤å·²å­˜åœ¨çš„å®¹å™¨ä»¥é¿å…åç¨±è¡çª
          docker rm -f mysql_db backend_app_1 backend_app_2 backend_app_3 nginx_proxy || true
          
          # åœæ­¢ä¸¦ç§»é™¤èˆŠçš„å®¹å™¨ç¶²è·¯
          docker compose down --remove-orphans
          
          # é‡æ–°å»ºç½®ä¸¦å•Ÿå‹•
          docker compose up -d --build
          
          # æ¸…ç†æ‡¸ç©ºçš„ Docker æ˜ åƒæª”
          docker image prune -f
          
          echo "âœ¨ éƒ¨ç½²å®Œæˆ $(date)"
