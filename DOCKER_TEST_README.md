# Docker æ¸¬è©¦å®¹å™¨ä½¿ç”¨æŒ‡å—

## ğŸš€ å¿«é€Ÿé–‹å§‹

### æ–¹å¼ 1: ä½¿ç”¨æ¸¬è©¦è…³æœ¬ï¼ˆæ¨è–¦ï¼‰

```bash
# è³¦äºˆåŸ·è¡Œæ¬Šé™ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰
chmod +x test.sh

# åŸ·è¡Œæ¸¬è©¦è…³æœ¬
./test.sh
```

äº’å‹•å¼é¸å–®æœƒå¼•å°ä½ å®Œæˆæ¸¬è©¦ã€‚

### æ–¹å¼ 2: ç›´æ¥ä½¿ç”¨ Docker Compose

```bash
# 1. ç”Ÿæˆæ¸¬è©¦è³‡æ–™
docker compose run --rm test npm run test:setup

# 2. Redis æ•ˆèƒ½æ¸¬è©¦
docker compose run --rm test npm run test:redis

# 3. æ¸…é™¤æ¸¬è©¦è³‡æ–™
docker compose run --rm test npm run test:cleanup
```

## ğŸ“‹ æ¸¬è©¦èªªæ˜

### ç”Ÿæˆæ¸¬è©¦è³‡æ–™ (test:setup)

åœ¨è³‡æ–™åº«ä¸­ç”Ÿæˆï¼š

- ğŸª 5,000 å€‹æ¸¬è©¦å•†å®¶
- ğŸ± 25,000 å€‹æ¸¬è©¦é¤ç›’ï¼ˆæ¯å€‹å•†å®¶ 5 å€‹ï¼‰
- ğŸ“ åˆ†å¸ƒåœ¨å°åŒ—è»Šç«™å‘¨åœ 20 å…¬é‡Œç¯„åœå…§

**åŸ·è¡Œæ™‚é–“**: ç´„ 2-3 åˆ†é˜

**è³‡æ–™ç‰¹å¾µ**:

- æ¸¬è©¦ç”¨æˆ¶ email: `test{n}@merchant.com`ï¼ˆå­˜æ–¼ users è¡¨ï¼‰
- å•†å®¶é€é `user_id` é€£æ¥åˆ° users è¡¨
- é¤ç›’é€é `merchant_id` é€£æ¥åˆ° merchants è¡¨
- éš¨æ©Ÿåº§æ¨™ã€åç¨±ã€åƒ¹æ ¼ã€å–é¤æ™‚é–“
- è‡ªå‹•æ¸…é™¤èˆŠè³‡æ–™å¾Œç”Ÿæˆæ–°è³‡æ–™

**è³‡æ–™åº«çµæ§‹**:

```
users (id, email, role='merchant')
  â†“ user_id
merchants (id, user_id, store_name, lat, lng, location)
  â†“ merchant_id
mealboxes (id, merchant_id, name, price, quantity)
```

### Redis æ•ˆèƒ½æ¸¬è©¦ (test:redis)

æ¸¬è©¦ä¸åŒæœå°‹ç¯„åœä¸‹ï¼Œæœ‰/ç„¡ Redis å¿«å–çš„æ•ˆèƒ½å·®ç•°ã€‚

**æ¸¬è©¦ç¯„åœ**: 3km, 5km, 10km, 15km, 20km

**æ¸¬è©¦å…§å®¹**:

- ç„¡å¿«å–æŸ¥è©¢ï¼ˆç›´æ¥æŸ¥è©¢ MySQLï¼Œ3 æ¬¡å–å¹³å‡ï¼‰
- æœ‰å¿«å–æŸ¥è©¢ï¼ˆé¦–æ¬¡æŸ¥è©¢å¯«å…¥ + ç¬¬äºŒæ¬¡å¿«å–å‘½ä¸­ï¼‰
- è¨ˆç®—åŠ é€Ÿå€æ•¸ï¼ˆMySQL å¹³å‡ / Redis å¿«å–æ™‚é–“ï¼‰
- æ¯æ¬¡æŸ¥è©¢è¿”å›æœ€å¤š 200 ç­†çµæœ

**åŸ·è¡Œæ™‚é–“**: ç´„ 1-2 åˆ†é˜

**å¯¦éš›æ¸¬è©¦çµæœ**ï¼ˆ5,000 å•†å®¶ / 25,000 é¤ç›’ï¼‰:

```
ç¯„åœ(km) | è³‡æ–™é‡ | ç„¡å¿«å–(ms) | æœ‰å¿«å–-é¦–æ¬¡(ms) | æœ‰å¿«å–-å¿«å–(ms) | åŠ é€Ÿå€æ•¸
--------------------------------------------------------------------------------
     3.0 |    200 |      262.0 |           549.0 |           168.0 |     1.56x
     5.0 |    200 |      325.7 |           405.0 |            65.0 |     5.01x
    10.0 |    200 |      374.3 |           536.0 |            70.0 |     5.35x
    15.0 |    200 |      421.3 |           535.0 |            61.0 |     6.91x
    20.0 |    200 |      535.0 |           777.0 |            66.0 |     8.11x
```

**é—œéµç™¼ç¾**:

- ğŸš€ è³‡æ–™é‡è¶Šå¤§ï¼ŒRedis å„ªå‹¢è¶Šæ˜é¡¯ï¼ˆå¾ 1.56x åˆ° 8.11xï¼‰
- âš¡ 20km ç¯„åœï¼šMySQL éœ€ 535msï¼ŒRedis åªéœ€ 66ms
- ğŸ“ˆ æœå°‹ç¯„åœè¶Šå¤§ï¼Œæ•ˆèƒ½å·®è·è¶Šé¡¯è‘—
- ğŸ’¾ å¿«å–å‘½ä¸­æ™‚é–“ç©©å®šåœ¨ 61-168ms ä¹‹é–“

### æ¸…é™¤æ¸¬è©¦è³‡æ–™ (test:cleanup)

æŒ‰ç…§æ­£ç¢ºçš„é †åºåˆªé™¤æ¸¬è©¦è³‡æ–™ï¼š

1. åˆªé™¤æ¸¬è©¦é¤ç›’ï¼ˆé€é JOIN merchants å’Œ usersï¼‰
2. åˆªé™¤æ¸¬è©¦å•†å®¶ï¼ˆé€é JOIN usersï¼‰
3. åˆªé™¤æ¸¬è©¦ç”¨æˆ¶ï¼ˆemail ç¬¦åˆ `test%@merchant.com`ï¼‰

**åŸ·è¡Œæ™‚é–“**: ç´„ 10-20 ç§’ï¼ˆè³‡æ–™é‡å¤§æ™‚éœ€æ›´ä¹…ï¼‰

## ğŸ—ï¸ æ¶æ§‹èªªæ˜

### Docker Compose é…ç½®

```yaml
test:
  build:
    context: ./backend
    dockerfile: Dockerfile.test
  container_name: test_container
  depends_on:
    mysql:
      condition: service_healthy
  networks:
    - app_net
  profiles:
    - test # åªåœ¨éœ€è¦æ™‚å•Ÿå‹•
```

**ç‰¹é»**:

- âœ… ä½¿ç”¨ `profiles: [test]`ï¼Œä¸æœƒåœ¨ `docker compose up` æ™‚è‡ªå‹•å•Ÿå‹•
- âœ… ä½¿ç”¨ `--rm` æ¨™è¨˜ï¼Œæ¸¬è©¦å¾Œè‡ªå‹•æ¸…ç†å®¹å™¨
- âœ… è‡ªå‹•ç­‰å¾… MySQL å¥åº·æª¢æŸ¥é€šé
- âœ… èˆ‡å¾Œç«¯æœå‹™å…±ç”¨åŒä¸€ç¶²è·¯ï¼Œå¯ç›´æ¥é€£ç·šåˆ° `mysql` ä¸»æ©Ÿ

### ç’°å¢ƒè‡ªå‹•åµæ¸¬

æ¸¬è©¦è…³æœ¬æœƒè‡ªå‹•åµæ¸¬åŸ·è¡Œç’°å¢ƒï¼š

```typescript
// Docker ç’°å¢ƒä¸­ä½¿ç”¨ 'mysql'ï¼Œæœ¬æ©Ÿç’°å¢ƒä½¿ç”¨ 'localhost'
const isDocker =
  process.env.DB_HOST === "mysql" || process.env.NODE_ENV === "docker";
const dbHost = isDocker ? "mysql" : "localhost";
```

é€™æ¨£åŒä¸€ä»½ç¨‹å¼ç¢¼å¯ä»¥ï¼š

- âœ… åœ¨ Docker å®¹å™¨å…§åŸ·è¡Œ
- âœ… åœ¨æœ¬æ©Ÿç›´æ¥åŸ·è¡Œï¼ˆ`npx ts-node`ï¼‰

## ğŸ”§ æœ¬æ©ŸåŸ·è¡Œï¼ˆä¸ä½¿ç”¨ Dockerï¼‰

å¦‚æœä½ æƒ³åœ¨æœ¬æ©Ÿç›´æ¥åŸ·è¡Œæ¸¬è©¦ï¼š

```bash
# ç¢ºä¿ MySQL å¯å¾ localhost:3306 é€£ç·š
docker compose ps mysql_db

# ç”Ÿæˆæ¸¬è©¦è³‡æ–™
npx ts-node backend/tests/setup-test-data.ts

# Redis æ•ˆèƒ½æ¸¬è©¦
npx ts-node backend/tests/redis-performance-test.ts

# æ¸…é™¤æ¸¬è©¦è³‡æ–™
npx ts-node backend/tests/cleanup-test-data.ts
```

## ğŸ“Š èˆ‡ K6 è² è¼‰æ¸¬è©¦æ•´åˆ

å»ºè­°çš„æ¸¬è©¦æµç¨‹ï¼š

```bash
# 1. ç”Ÿæˆæ¸¬è©¦è³‡æ–™
./test.sh  # é¸æ“‡é¸é … 1

# 2. åŸ·è¡Œ K6 è² è¼‰æ¸¬è©¦
k6 run test_k6_redis.js

# 3. æ¸…é™¤æ¸¬è©¦è³‡æ–™ï¼ˆå¯é¸ï¼‰
./test.sh  # é¸æ“‡é¸é … 3
```

## ğŸ› æ•…éšœæ’é™¤

### å®¹å™¨ç„¡æ³•å•Ÿå‹•

```bash
# æª¢æŸ¥ MySQL æ˜¯å¦å¥åº·
docker compose ps mysql

# æŸ¥çœ‹æ—¥èªŒ
docker compose logs mysql

# é‡å•Ÿ MySQL
docker compose restart mysql
```

### é€£ç·šéŒ¯èª¤

```bash
# ç¢ºèªç¶²è·¯è¨­å®š
docker network ls
docker network inspect lefty_app_net

# æ¸¬è©¦å¾å®¹å™¨å…§é€£ç·š
docker compose run --rm test sh -c "ping mysql"
```

### æ¸¬è©¦è³‡æ–™æœªç”Ÿæˆ

```bash
# é€²å…¥å®¹å™¨æª¢æŸ¥
docker compose run --rm test sh

# æ‰‹å‹•åŸ·è¡Œ
npm run test:setup
```

### æ¬Šé™å•é¡Œ

```bash
# å¦‚æœ test.sh ç„¡æ³•åŸ·è¡Œ
chmod +x test.sh
```

## ğŸ’¡ é€²éšç”¨æ³•

### è‡ªè¨‚æ¸¬è©¦åƒæ•¸

ä¿®æ”¹ `backend/tests/setup-test-data.ts` ä¸­çš„ `config`:

```typescript
const config: TestDataConfig = {
  centerLat: 25.0478, // ä¸­å¿ƒç·¯åº¦ï¼ˆå°åŒ—è»Šç«™ï¼‰
  centerLng: 121.517, // ä¸­å¿ƒç¶“åº¦
  merchantCount: 5000, // å•†å®¶æ•¸é‡ï¼ˆå»ºè­° 5000+ ä»¥å±•ç¾ Redis å„ªå‹¢ï¼‰
  mealboxesPerMerchant: 5, // æ¯å€‹å•†å®¶çš„é¤ç›’æ•¸é‡
  radiusKm: 20, // åˆ†å¸ƒç¯„åœï¼ˆå…¬é‡Œï¼‰
};
```

ä¿®æ”¹ `backend/tests/redis-performance-test.ts` ä¸­çš„æ¸¬è©¦ç¯„åœå’Œè³‡æ–™é‡:

```typescript
const testRadii = [
  3000, // 3 km
  5000, // 5 km
  10000, // 10 km
  15000, // 15 km
  20000, // 20 km
];

// èª¿æ•´è¿”å›çš„è³‡æ–™é‡ï¼ˆé è¨­ 200ï¼‰
const limit = 200; // åœ¨ queryWithoutRedis å’Œ queryWithRedis å‡½æ•¸ä¸­
```

ğŸ’¡ **å»ºè­°**:

- å•†å®¶æ•¸é‡è¶Šå¤šï¼ŒRedis æ•ˆèƒ½å„ªå‹¢è¶Šæ˜é¡¯
- æœå°‹ç¯„åœè¶Šå¤§ï¼Œè³‡æ–™è™•ç†è¶Šè¤‡é›œï¼Œå¿«å–æ•ˆç›Šè¶Šé«˜
- å°è³‡æ–™é‡æ™‚ï¼ˆ< 1000 ç­†ï¼‰ï¼ŒMySQL æœ¬åœ°æŸ¥è©¢å¯èƒ½æ›´å¿«

````

### åªå»ºç½®æ¸¬è©¦å®¹å™¨

```bash
# å»ºç½®æ¸¬è©¦å®¹å™¨
docker compose build test

# æŸ¥çœ‹æ˜ åƒ
docker images | grep test
````

### é€²å…¥æ¸¬è©¦å®¹å™¨äº’å‹•æ¨¡å¼

```bash
# å•Ÿå‹• shell
docker compose run --rm test sh

# åœ¨å®¹å™¨å…§å¯ä»¥åŸ·è¡Œä»»ä½•å‘½ä»¤
npm run test:setup
npm run test:redis
npm run test:cleanup
exit
```

## ğŸ“ æœ€ä½³å¯¦è¸

1. **æ¸¬è©¦å‰ç¢ºèªæœå‹™æ­£å¸¸**

   ```bash
   docker compose ps
   # ç¢ºä¿ mysql_db ç‹€æ…‹ç‚º healthy
   ```

2. **å®šæœŸæ¸…é™¤èˆŠè³‡æ–™**

   - æ¸¬è©¦è³‡æ–™æœƒç´¯ç©ï¼Œå®šæœŸæ¸…é™¤å¯ä¿æŒè³‡æ–™åº«ä¹¾æ·¨

3. **å®Œæ•´æ¸¬è©¦æµç¨‹**

   - ä½¿ç”¨é¸é … 4 åŸ·è¡Œå®Œæ•´æµç¨‹ï¼Œç¢ºä¿ç’°å¢ƒä¸€è‡´

4. **ç›£æ§è³‡æºä½¿ç”¨**

   ```bash
   docker stats test_container
   ```

5. **ä¿å­˜æ¸¬è©¦çµæœ**
   - Redis æ•ˆèƒ½æ¸¬è©¦æœƒè¼¸å‡ºåˆ° stdoutï¼Œå¯ä»¥é‡å®šå‘å„²å­˜
   ```bash
   docker compose run --rm test npm run test:redis > test_results.txt
   ```

## ğŸ¯ ç¸½çµ

ä½¿ç”¨ Docker æ¸¬è©¦å®¹å™¨çš„å„ªé»ï¼š

âœ… **ç’°å¢ƒä¸€è‡´æ€§** - æ¸¬è©¦ç’°å¢ƒèˆ‡ç”Ÿç”¢ç’°å¢ƒä¸€è‡´  
âœ… **ä¾è³´éš”é›¢** - ä¸å½±éŸ¿æœ¬æ©Ÿç’°å¢ƒ  
âœ… **è‡ªå‹•åŒ–** - ä¸€éµåŸ·è¡Œæ‰€æœ‰æ¸¬è©¦  
âœ… **å¯é‡è¤‡æ€§** - æ¯æ¬¡æ¸¬è©¦çµæœä¸€è‡´  
âœ… **æ˜“æ–¼æ•´åˆ** - å¯è¼•é¬†æ•´åˆåˆ° CI/CD æµç¨‹
