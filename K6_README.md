# K6 è² è¼‰æ¸¬è©¦æŒ‡å—

## ğŸ“‹ æ¸¬è©¦æª”æ¡ˆèªªæ˜

### 1. **test_k6.js** - åŸºç¤è² è¼‰æ¸¬è©¦

- æ¸¬è©¦ Nginx è² è¼‰å‡è¡¡
- æ¸¬è©¦ `/user/nearby` API
- æ¸¬è©¦ Redis å¿«å–å‘½ä¸­ç‡
- æ¨¡æ“¬çœŸå¯¦ç”¨æˆ¶è¡Œç‚º

### 2. **test_k6_redis.js** - Redis å¿«å–å°ˆé …æ¸¬è©¦

- å¿«å–é ç†±éšæ®µ
- å¿«å–å‘½ä¸­ç‡æ¸¬è©¦
- å£“åŠ›æ¸¬è©¦
- è©³ç´°çš„å¿«å–æ•ˆèƒ½åˆ†æ

### 3. **test_k6_spike.js** - å°–å³°æµé‡æ¸¬è©¦

- æ¨¡æ“¬çªç™¼æµé‡ï¼ˆ10 â†’ 200 ç”¨æˆ¶ï¼‰
- æ¸¬è©¦ç³»çµ±ç©©å®šæ€§
- éŒ¯èª¤ç‡ç›£æ§

## ğŸš€ åŸ·è¡Œæ¸¬è©¦

### å‰ç½®éœ€æ±‚

å®‰è£ k6ï¼š

```bash
# macOS
brew install k6

# æˆ–ä¸‹è¼‰ï¼šhttps://k6.io/docs/getting-started/installation/
```

### åŸ·è¡ŒåŸºç¤æ¸¬è©¦

```bash
# 1. åŸºç¤è² è¼‰æ¸¬è©¦
k6 run test_k6.js

# 2. Redis å¿«å–æ¸¬è©¦
k6 run test_k6_redis.js

# 3. å°–å³°æµé‡æ¸¬è©¦
k6 run test_k6_spike.js
```

### ç”¢ç”Ÿ HTML å ±å‘Š

```bash
# å®‰è£å ±å‘Šæ¨¡çµ„ï¼ˆåƒ…éœ€ä¸€æ¬¡ï¼‰
npm install -g k6-html-reporter

# åŸ·è¡Œæ¸¬è©¦ä¸¦ç”¢ç”Ÿå ±å‘Š
k6 run --out json=results.json test_k6_redis.js

# æŸ¥çœ‹å ±å‘Š
open summary.html
```

### é€²éšé¸é …

```bash
# è‡ªè¨‚è™›æ“¬ç”¨æˆ¶æ•¸
k6 run --vus 100 --duration 30s test_k6.js

# åªåŸ·è¡Œç‰¹å®šå ´æ™¯
k6 run --scenario cache_hit_test test_k6_redis.js

# è¨­å®šç’°å¢ƒè®Šæ•¸
k6 run -e BASE_URL=http://localhost:8080 test_k6.js

# è¼¸å‡ºåˆ° InfluxDBï¼ˆéœ€å…ˆå®‰è£ï¼‰
k6 run --out influxdb=http://localhost:8086/k6 test_k6.js
```

## ğŸ“Š æ¸¬è©¦å ´æ™¯èªªæ˜

### test_k6.js - åŸºç¤è² è¼‰æ¸¬è©¦

**æ¸¬è©¦æµç¨‹ï¼š**

1. 30 ç§’ï¼šçˆ¬å‡åˆ° 10 ç”¨æˆ¶
2. 1 åˆ†é˜ï¼šçˆ¬å‡åˆ° 50 ç”¨æˆ¶
3. 2 åˆ†é˜ï¼šç¶­æŒ 50 ç”¨æˆ¶
4. 30 ç§’ï¼šé™å› 0

**æ¸¬è©¦å…§å®¹ï¼š**

- æŸ¥è©¢é™„è¿‘å•†å®¶ï¼ˆ5 å€‹ä¸åŒä½ç½® Ã— 3 ç¨®ç¯„åœï¼‰
- 30% æ©Ÿç‡é‡è¤‡æŸ¥è©¢ï¼ˆæ¸¬è©¦å¿«å–ï¼‰
- å¥åº·æª¢æŸ¥

**æˆåŠŸæ¨™æº–ï¼š**

- P95 å›æ‡‰æ™‚é–“ < 500ms
- éŒ¯èª¤ç‡ < 1%
- å¿«å–å‘½ä¸­ç‡ > 0

### test_k6_redis.js - Redis å¿«å–å°ˆé …æ¸¬è©¦

**æ¸¬è©¦åˆ†ä¸‰éšæ®µï¼š**

**éšæ®µ 1: å¿«å–é ç†±ï¼ˆ0-35 ç§’ï¼‰**

- 5 å€‹è™›æ“¬ç”¨æˆ¶
- æŸ¥è©¢æ‰€æœ‰é å®šç¾©ä½ç½®
- å¡«å…… Redis å¿«å–

**éšæ®µ 2: å¿«å–å‘½ä¸­ç‡æ¸¬è©¦ï¼ˆ35 ç§’-1 åˆ† 35 ç§’ï¼‰**

- 20 å€‹è™›æ“¬ç”¨æˆ¶
- 80% æŸ¥è©¢å·²å¿«å–ä½ç½®
- 20% æŸ¥è©¢æ–°ä½ç½®

**éšæ®µ 3: å£“åŠ›æ¸¬è©¦ï¼ˆ1 åˆ† 35 ç§’-5 åˆ† 35 ç§’ï¼‰**

- 0 â†’ 50 â†’ 100 â†’ 150 â†’ 0 ç”¨æˆ¶
- æ··åˆå¿«å–å’Œéå¿«å–æŸ¥è©¢
- æ¸¬è©¦æ¥µé™è² è¼‰

**æˆåŠŸæ¨™æº–ï¼š**

- å¿«å–å‘½ä¸­å›æ‡‰ < 50ms
- éå¿«å–å›æ‡‰ < 500ms
- å¿«å–å‘½ä¸­ç‡ > 70%
- éŒ¯èª¤ç‡ < 1%

### test_k6_spike.js - å°–å³°æµé‡æ¸¬è©¦

**æ¸¬è©¦æµç¨‹ï¼š**

1. 10 ç§’ï¼šæ­£å¸¸æµé‡ï¼ˆ10 ç”¨æˆ¶ï¼‰
2. 30 ç§’ï¼šçªç„¶çˆ†é‡ï¼ˆ10 â†’ 200ï¼‰
3. 1 åˆ†é˜ï¼šç¶­æŒé«˜å³°ï¼ˆ200 ç”¨æˆ¶ï¼‰
4. 10 ç§’ï¼šå›åˆ°æ­£å¸¸ï¼ˆ200 â†’ 10ï¼‰
5. 10 ç§’ï¼šçµæŸï¼ˆ10 â†’ 0ï¼‰

**æˆåŠŸæ¨™æº–ï¼š**

- P95 å›æ‡‰æ™‚é–“ < 2 ç§’
- éŒ¯èª¤ç‡ < 5%
- æˆåŠŸç‡ > 95%

## ğŸ“ˆ æŒ‡æ¨™èªªæ˜

### HTTP æŒ‡æ¨™

- **http_req_duration**: è«‹æ±‚ç¸½æ™‚é•·
- **http_req_waiting**: ç­‰å¾…é¦–ä½å…ƒçµ„æ™‚é–“ï¼ˆTTFBï¼‰
- **http_req_connecting**: TCP é€£ç·šæ™‚é–“
- **http_req_failed**: å¤±æ•—è«‹æ±‚ç‡

### è‡ªè¨‚æŒ‡æ¨™

- **cache_hits**: å¿«å–å‘½ä¸­æ¬¡æ•¸
- **cache_misses**: å¿«å–æœªå‘½ä¸­æ¬¡æ•¸
- **cache_hit_rate**: å¿«å–å‘½ä¸­ç‡
- **cached_response_time**: å¿«å–å›æ‡‰æ™‚é–“
- **uncached_response_time**: éå¿«å–å›æ‡‰æ™‚é–“

## ğŸ¯ é–¾å€¼ (Thresholds)

é–¾å€¼å®šç¾©äº†æ¸¬è©¦çš„æˆåŠŸæ¨™æº–ï¼š

```javascript
thresholds: {
    'http_req_duration': ['p(95)<500'],        // 95% è«‹æ±‚ < 500ms
    'http_req_failed': ['rate<0.01'],          // å¤±æ•—ç‡ < 1%
    'cache_hit_rate': ['rate>0.7'],            // å‘½ä¸­ç‡ > 70%
}
```

- `p(95)`: ç¬¬ 95 ç™¾åˆ†ä½æ•¸
- `rate`: æ¯”ç‡
- `count`: è¨ˆæ•¸

## ğŸ“Š è®€å–æ¸¬è©¦çµæœ

### çµ‚ç«¯è¼¸å‡º

æ¸¬è©¦éç¨‹ä¸­æœƒå³æ™‚é¡¯ç¤ºï¼š

```
scenarios: (100.00%) 1 scenario, 50 max VUs, 3m30s max duration
âœ“ nearby: status is 200
âœ“ cache_hit_rate: rate>0.7

http_req_duration..............: avg=45.2ms   min=2.1ms  med=38.5ms  max=456ms p(95)=98.3ms
cache_hits.....................: 1234   20.5/s
cache_misses...................: 345    5.7/s
```

### HTML å ±å‘Š

åŒ…å«ï¼š

- è¦–è¦ºåŒ–åœ–è¡¨
- è©³ç´°æŒ‡æ¨™çµ±è¨ˆ
- å¤±æ•—è«‹æ±‚æ¸…å–®
- æ™‚é–“è»¸åˆ†æ

## ğŸ”§ æ•…éšœæ’é™¤

### é€£ç·šè¢«æ‹’çµ•

```bash
# ç¢ºèª backend æ­£åœ¨é‹è¡Œ
docker compose ps

# æª¢æŸ¥ Nginx
curl http://localhost/health
```

### å¿«å–å‘½ä¸­ç‡å¤ªä½

- æª¢æŸ¥ Redis æ˜¯å¦æ­£å¸¸é‹ä½œ
- æŸ¥çœ‹ Redis TTL è¨­å®šï¼ˆé è¨­ 30 ç§’ï¼‰
- ç¢ºèªæ¸¬è©¦æŸ¥è©¢æœ‰é‡è¤‡

### å›æ‡‰æ™‚é–“éé•·

- æª¢æŸ¥è³‡æ–™åº«ç´¢å¼•ï¼ˆspatial indexï¼‰
- æŸ¥çœ‹ MySQL æ…¢æŸ¥è©¢æ—¥èªŒ
- å¢åŠ  backend å®¹å™¨æ•¸é‡

### éŒ¯èª¤ç‡éé«˜

```bash
# æŸ¥çœ‹ backend æ—¥èªŒ
docker compose logs -f backend1

# æª¢æŸ¥è³‡æ–™åº«é€£ç·š
docker compose exec mysql_db mysql -u root -p
```

## ğŸ’¡ æœ€ä½³å¯¦è¸

### 1. å¾ªåºæ¼¸é€²

å…ˆåŸ·è¡Œå°è¦æ¨¡æ¸¬è©¦ï¼Œç¢ºèªç„¡èª¤å¾Œå†å¢åŠ è² è¼‰ã€‚

### 2. æº–å‚™æ¸¬è©¦è³‡æ–™

åŸ·è¡Œè² è¼‰æ¸¬è©¦å‰ï¼Œå…ˆé‹è¡Œ `setup-test-data.ts` ç”¢ç”Ÿè¶³å¤ çš„æ¸¬è©¦è³‡æ–™ã€‚

### 3. ç›£æ§ç³»çµ±è³‡æº

```bash
# ç›£æ§ Docker è³‡æºä½¿ç”¨
docker stats

# ç›£æ§ Redis
docker compose exec redis redis-cli INFO stats
```

### 4. æ¸¬è©¦ç’°å¢ƒéš”é›¢

ä¸è¦åœ¨ç”Ÿç”¢ç’°å¢ƒåŸ·è¡Œè² è¼‰æ¸¬è©¦ï¼

### 5. è¨˜éŒ„åŸºæº–ç·š

ç¬¬ä¸€æ¬¡æ¸¬è©¦çš„çµæœä½œç‚ºåŸºæº–ï¼Œå¾ŒçºŒå„ªåŒ–å¾Œæ¯”è¼ƒã€‚

## ğŸ“ ç¯„ä¾‹æ¸¬è©¦æµç¨‹

```bash
# 1. å•Ÿå‹•æ‰€æœ‰æœå‹™
docker compose up -d

# 2. ç”Ÿæˆæ¸¬è©¦è³‡æ–™
npx ts-node backend/tests/setup-test-data.ts

# 3. åŸ·è¡Œå¿«å–é ç†±
curl "http://localhost/user/nearby?lat=25.0478&lng=121.5170&radius=3000&limit=50"

# 4. åŸ·è¡Œ k6 æ¸¬è©¦
k6 run test_k6_redis.js

# 5. æŸ¥çœ‹å ±å‘Š
open summary.html

# 6. åˆ†æçµæœä¸¦èª¿æ•´
# - å¢åŠ  Redis TTLï¼Ÿ
# - å¢åŠ  backend å®¹å™¨ï¼Ÿ
# - èª¿æ•´è³‡æ–™åº«åƒæ•¸ï¼Ÿ

# 7. é‡æ–°æ¸¬è©¦é©—è­‰
k6 run test_k6_redis.js
```

## ğŸ“ å»¶ä¼¸å­¸ç¿’

- [K6 å®˜æ–¹æ–‡ä»¶](https://k6.io/docs/)
- [K6 æœ€ä½³å¯¦è¸](https://k6.io/docs/testing-guides/test-types/)
- [è² è¼‰æ¸¬è©¦é¡å‹](https://k6.io/docs/test-types/)
