#!/bin/bash
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# act-pipeline.sh â€” æœ¬åœ°æ¨¡æ“¬å®Œæ•´ CI â†’ CD ä¸²æ¥æµç¨‹
#
# ä½¿ç”¨æ–¹å¼ï¼š
#   chmod +x act-pipeline.sh    # ç¬¬ä¸€æ¬¡ä½¿ç”¨å‰è³¦äºˆåŸ·è¡Œæ¬Šé™
#   ./act-pipeline.sh           # è·‘å®Œæ•´ CI â†’ CD
#   ./act-pipeline.sh ci        # åªè·‘ CI
#   ./act-pipeline.sh cd        # åªè·‘ CD
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

set -euo pipefail

# â”€â”€ é¡è‰²å®šç¾© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info()    { echo -e "${BLUE}[INFO]${NC}  $1"; }
log_success() { echo -e "${GREEN}[âœ… OK]${NC}  $1"; }
log_warn()    { echo -e "${YELLOW}[WARN]${NC}  $1"; }
log_error()   { echo -e "${RED}[âŒ FAIL]${NC} $1"; }

# â”€â”€ Secrets æª”æ¡ˆæª¢æŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SECRETS_FILE=".secrets"

check_secrets() {
  if [ ! -f "$SECRETS_FILE" ]; then
    log_warn ".secrets æª”æ¡ˆä¸å­˜åœ¨ï¼ŒCD æ­¥é©Ÿå°‡ä½¿ç”¨æœ¬åœ°ç¾æœ‰çš„ .env æª”æ¡ˆ"
    log_warn "å¦‚éœ€æ¨¡æ“¬ GitHub Secretsï¼Œè«‹å»ºç«‹ .secrets æª”æ¡ˆï¼š"
    log_warn "  echo 'ENV_FILE=\$(cat .env | base64)' > .secrets  # ç¯„ä¾‹"
  fi
}

# â”€â”€ åŸ·è¡Œ CI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
run_ci() {
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  log_info "ğŸ”¬ é–‹å§‹åŸ·è¡Œ CI (Backend_Tests)"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  if act push -W .github/workflows/ci.yml; then
    echo ""
    log_success "CI å…¨éƒ¨é€šéï¼"
    return 0
  else
    echo ""
    log_error "CI å¤±æ•—ï¼Œä¸­æ­¢æµç¨‹ï¼Œä¸åŸ·è¡Œ CD"
    return 1
  fi
}

# â”€â”€ åŸ·è¡Œ CD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
run_cd() {
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  log_info "ğŸš€ é–‹å§‹åŸ·è¡Œ CD (Deploy)"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # å¦‚æœæœ‰ .secrets å°±å¸¶å…¥ï¼Œå¦å‰‡ç›´æ¥è·‘ï¼ˆcd.yml æœƒè‡ªå‹• fallback åˆ°ç¾æœ‰ .envï¼‰
  if [ -f "$SECRETS_FILE" ]; then
    log_info "ä½¿ç”¨ $SECRETS_FILE ä½œç‚º GitHub Secrets"
    CD_CMD="act workflow_dispatch -W .github/workflows/cd.yml --secret-file $SECRETS_FILE"
  else
    log_warn "ç„¡ .secrets æª”ï¼ŒCD å°‡ä½¿ç”¨æœ¬åœ° .env"
    CD_CMD="act workflow_dispatch -W .github/workflows/cd.yml"
  fi

  if $CD_CMD; then
    echo ""
    log_success "CD éƒ¨ç½²æˆåŠŸï¼"
    return 0
  else
    echo ""
    log_error "CD éƒ¨ç½²å¤±æ•—"
    return 1
  fi
}

# â”€â”€ ä¸»æµç¨‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MODE="${1:-all}"

check_secrets

case "$MODE" in
  ci)
    run_ci
    ;;
  cd)
    run_cd
    ;;
  all|*)
    run_ci
    echo ""
    log_info "â­  CI é€šéï¼Œ3 ç§’å¾Œå•Ÿå‹• CD..."
    sleep 3
    run_cd
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    log_success "å®Œæ•´ CI â†’ CD æµç¨‹åŸ·è¡Œå®Œç•¢ï¼"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    ;;
esac
