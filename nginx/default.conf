# -------------------------------
# upstream 區塊：定義後端 API 叢集（多個 Node.js container）
# -------------------------------
upstream api_pool {
    # 這三個 server 都是你的 docker-compose 中的 service 名稱
    # Nginx 會使用 round-robin（預設）輪詢這三台
    server backend1:3000;
    server backend2:3000;
    server backend3:3000;

    # keepalive 保持與後端保持 TCP 連線，減少連線開銷
    # 效果：降低 latency（避免重複 TCP 握手）
    keepalive 32;
}

# -------------------------------
# HTTP server 設定
# -------------------------------
server {

    # Nginx 在 container 裡接 port 80
    listen 80;

    # 可選：設定 server_name，不設定也沒影響
    server_name _;

    # 允許上傳最大 50MB 的請求體 (包含檔案和 form-data)
    client_max_body_size 50M;

    
    # -------------------------------
    # 主要反向代理設定：所有路徑都轉往 upstream
    # -------------------------------
    location / {
        # 將所有流量代理到 upstream api_pool
        proxy_pass http://api_pool;

        # 使用 HTTP/1.1 才可以支援 keepalive
        proxy_http_version 1.1;

        # 如果不清空 Connection header，Nginx 會預設加 `Connection: close`
        # 會導致後端 Keep-Alive 失效
        proxy_set_header Connection "";

        # 保留 client 的 request headers（重要）
        proxy_set_header Host $host;                      # 原始 Host
        proxy_set_header X-Real-IP $remote_addr;          # 取得 client 真實 IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # 多層 proxy 追蹤 IP
        proxy_set_header X-Forwarded-Proto $scheme;       # HTTP or HTTPS
    }

    # -------------------------------
    # 可選：Gzip 壓縮（可提升前端載入速度）
    # -------------------------------
    gzip on;
    gzip_types text/plain application/json text/css application/javascript;
    gzip_min_length 1000;  # 小於 1KB 不壓縮
    gzip_comp_level 5;     # 壓縮等級（1 快但壓不多；9 壓很多但 CPU 高）

    # -------------------------------
    # Proxy 超時與 buffer 設定（在高負載更穩定）
    # -------------------------------
    proxy_connect_timeout 5s;    # 與後端建立 TCP 連線的時間
    proxy_send_timeout 30s;      # 請求送到後端的時間上限
    proxy_read_timeout 30s;      # 後端回應資料等待時間

    proxy_buffer_size 8k;        # 單 buffer 大小
    proxy_buffers 4 32k;         # 建議：4 個 32k buffer
    proxy_busy_buffers_size 64k; # 高負載時的緩衝大小

    # -------------------------------
    # Access Log / Error Log（偵錯用）
    # -------------------------------
    access_log /var/log/nginx/access.log;
    error_log  /var/log/nginx/error.log warn;
}
